# Spacer

Современная контейнеризованная система управления удаленными рабочими столами на основе Apache Guacamole.

## Архитектура

Этот проект предоставляет полное решение для управления удаленными подключениями к рабочим столам через Apache Guacamole с бэкендом PostgreSQL и возможностями записи сессий.

### Компоненты

- **Apache Guacamole** - Шлюз удаленного рабочего стола с поддержкой WebSocket
- **Guacd** - Демон Guacamole для обработки протоколов (VNC, RDP, SSH, Telnet)
- **PostgreSQL** - База данных для конфигурации Guacamole и пользовательских данных
- **PgAdmin** - Веб-интерфейс для управления базой данных
- **Session Recordings** - Сервер на базе Tomcat для просмотра записанных сессий
- **Nginx** - Обратный прокси с поддержкой WebSocket для Guacamole
- **Extensions** - Дополнительные расширения аутентификации и функциональности Guacamole

## Быстрый старт

1. **Развернуть все сервисы:**
   ```bash
   make deploy
   ```

2. **Доступ к приложениям:**
   - **Веб-интерфейс Guacamole:** http://localhost/guacamole/
   - **Записи сессий:** http://localhost/recordings/
   - **PgAdmin:** http://localhost:8999

3. **Просмотр логов:**
   ```bash
   docker compose logs -f
   ```

## Возможности

- **Поддержка множественных протоколов:** Подключения VNC, RDP, SSH, Telnet
- **Запись сессий:** Полная запись и воспроизведение сессий
- **Аутентификация через базу данных:** Управление пользователями через PostgreSQL
- **WebSocket туннелирование:** Нативный браузерный удаленный доступ
- **Балансировка нагрузки:** Обратный прокси Nginx для масштабируемости
- **Мониторинг состояния:** Встроенные проверки здоровья для всех сервисов

## Конфигурация записи сессий

### Создание подключений с записью

Для включения записи сессий для ваших подключений выполните следующие шаги:

1. **Доступ к административному интерфейсу Guacamole:**
   - Перейдите по адресу: `http://your-server/guacamole/#/settings/postgresql/connections`
   - Войдите как `guacadmin` / `guacadmin`

2. **Создание нового подключения:**
   - Нажмите кнопку "New Connection"
   - Заполните детали подключения:

   **Основные настройки:**
   - **Имя:** Описательное имя для вашего подключения
   - **Протокол:** SSH, RDP, VNC или Telnet
   - **Имя хоста:** IP-адрес или имя целевого сервера
   - **Порт:** Порт подключения (22 для SSH, 3389 для RDP, 5900+ для VNC)
   - **Имя пользователя:** Имя пользователя для входа
   - **Пароль:** Пароль для входа (или используйте аутентификацию по ключу для SSH)

   **Настройки записи:**
   - **Путь записи:** `/record/${HISTORY_UUID}`
   - **Имя записи:** `session` (или любое описательное имя)
   - **Создавать путь записи автоматически:** ✅ Включить эту опцию

3. **Примеры конфигураций подключений:**

   **SSH подключение:**
   ```
   Имя: Production Server SSH
   Протокол: SSH
   Имя хоста: 192.168.1.100
   Порт: 22
   Имя пользователя: admin
   Пароль: your_password
   Путь записи: /record/${HISTORY_UUID}
   Имя записи: session
   ```

   **RDP подключение:**
   ```
   Имя: Windows Server RDP
   Протокол: RDP
   Имя хоста: 192.168.1.200
   Порт: 3389
   Имя пользователя: administrator
   Пароль: your_password
   Путь записи: /record/${HISTORY_UUID}
   Имя записи: session
   ```

   **VNC подключение:**
   ```
   Имя: Linux Desktop VNC
   Протокол: VNC
   Имя хоста: 192.168.1.150
   Порт: 5901
   Пароль: vnc_password
   Путь записи: /record/${HISTORY_UUID}
   Имя записи: session
   ```

### Структура файлов записей

Записи автоматически сохраняются в директорию хоста:
```
_data/guacd/record/
├── {HISTORY_UUID_1}/
│   └── session.guac
├── {HISTORY_UUID_2}/
│   └── session.guac
└── {HISTORY_UUID_3}/
    └── session.guac
```

### Просмотр записей

1. **Доступ к истории:**
   - Перейдите в основной интерфейс Guacamole
   - Нажмите на вкладку "History"
   - Найдите сессию вашего подключения

2. **Воспроизведение:**
   - Найдите ссылку "View" в колонке "Logs"
   - Нажмите для открытия интерфейса воспроизведения записи
   - Используйте элементы управления для навигации по сессии

### Важные заметки

- **Путь записи:** Всегда используйте формат `/record/${HISTORY_UUID}`
- **Автоматическое создание пути:** Включите опцию "Create recording path automatically"
- **Права доступа к файлам:** Система автоматически устанавливает правильные права (1000:1001, 775)
- **Место хранения:** Записи хранятся в `_data/guacd/record/` на хосте
- **Формат файла:** Записи сохраняются в формате `.guac` для эффективного хранения

## Структура проекта

```
├── _data/                    # Постоянные тома данных
│   ├── guacamole/           # Конфигурация и расширения Guacamole
│   ├── guacd/               # Данные демона Guacamole и записи
│   ├── postgres/            # Данные и инициализация PostgreSQL
│   └── tomcat/              # Конфигурация Tomcat для записей
├── docker-compose.yml       # Оркестрация сервисов
├── env_files/               # Конфигурация окружения
│   ├── guacamole.env        # Настройки Guacamole
│   ├── pgadmin.env         # Настройки PgAdmin
│   └── postgres.env        # Настройки PostgreSQL
├── nginx/                   # Конфигурация обратного прокси
│   ├── nginx.conf           # Основная конфигурация Nginx
│   └── conf.d/              # Конфигурация для конкретных сайтов
└── Makefile                # Команды разработки и развертывания
```

## Конфигурация

### Переменные окружения

Ключевые файлы конфигурации в `env_files/`:

- **PostgreSQL:** Настройки подключения к базе данных и инициализации
- **Guacamole:** Конфигурация аутентификации и подключения к guacd
- **PgAdmin:** Учетные данные доступа к административному интерфейсу

### Расширения

Доступные расширения Guacamole в `_data/guacamole/extensions/`:
- **guacamole-auth-jdbc** - Аутентификация через базу данных
- **guacamole-auth-quickconnect** - Шаблоны быстрых подключений
- **guacamole-auth-sso** - Аутентификация единого входа
- **guacamole-display-statistics** - Статистика подключений
- **guacamole-history-recording-storage** - Хранение записей сессий

## Доступные команды

```bash
make help          # Показать все доступные команды
make pull          # Загрузить все Docker образы
make deploy        # Развернуть все сервисы
make down          # Остановить и удалить все контейнеры
make prune         # Очистить систему Docker
```

## Доступ по умолчанию

- **Guacamole:** Доступ к веб-интерфейсу и настройка подключений через административный интерфейс
- **PgAdmin:** Используйте учетные данные по умолчанию из `env_files/pgadmin.env` для управления базой данных PostgreSQL
- **Настройка администратора:** Система автоматически создает пользователя `guacadmin` при инициализации

## Устранение неполадок

### Общие проблемы

1. **Проверка состояния сервисов:**
   ```bash
   docker compose ps
   ```

2. **Просмотр логов сервисов:**
   ```bash
   docker compose logs [service-name]
   ```

3. **Перезапуск конкретного сервиса:**
   ```bash
   docker compose restart [service-name]
   ```

### Проблемы с записями

**Проблема: Записи не отображаются в веб-интерфейсе**

1. **Проверка прав доступа к директории записей:**
   ```bash
   ls -la _data/guacd/record/
   # Должно показывать: drwxrwxr-x 1000 1001
   ```

2. **Исправление прав при необходимости:**
   ```bash
   sudo chown -R 1000:1001 _data/guacd/record
   sudo chmod -R 775 _data/guacd/record
   ```

3. **Проверка пути записи в настройках подключения:**
   - Должно быть: `/record/${HISTORY_UUID}`
   - НЕ должно быть: `/record/${HISTORY_PATH}/${HISTORY_UUID}`

4. **Проверка логов guacd на ошибки записи:**
   ```bash
   docker compose logs guacd | grep -i recording
   ```

**Проблема: Ошибка "No such file or directory" в логах guacd**

- Убедитесь, что включена опция "Create recording path automatically"
- Проверьте формат пути записи: `/record/${HISTORY_UUID}`
- Проверьте, что директория записи существует и имеет правильные права

**Проблема: Невозможно просматривать записи в браузере**

- Убедитесь, что файлы записей существуют в `_data/guacd/record/{UUID}/`
- Проверьте, что контейнер guacamole может читать файлы (права 775)
- Перезапустите контейнер guacamole: `docker compose restart guacamole`

## Вклад в проект

1. **Внесите необходимые изменения в файлы конфигурации**
2. **Протестируйте развертывание:** `make deploy`
3. **Проверьте функциональность** всех сервисов
4. **Документируйте любые новые функции или изменения**




# Wireguard

## *ВАЖНО*:

Если после перезагрузки сервера клиенты не могут никуда достучаться и `traceroute` обрывается на wg сервере, нужно в настройках `wireguard-ui` в разделе сервера прописать (указывай корректную сеть в `POSTROUTING` !!!):

```bash
# PostUp
iptables -A FORWARD -i %i -o eth0 -j ACCEPT; iptables -A FORWARD -i eth0 -o %i -m state --state RELATED,ESTABLISHED -j ACCEPT; iptables -t nat -A POSTROUTING -s 10.100.0.0/24 -o eth0 -j MASQUERADE

# PostDown
iptables -D FORWARD -i %i -o eth0 -j ACCEPT; iptables -D FORWARD -i eth0 -o %i -m state --state RELATED,ESTABLISHED -j ACCEPT; iptables -t nat -D POSTROUTING -s 10.100.0.0/24 -o eth0 -j MASQUERADE

```
